# コンテンツ保存先指定機能 仕様書

## 1. 背景・目的

### 現状の問題点
- コンテンツの保存先が `content` フォルダに固定されている
- テスト実行時も本番用の `content` フォルダが使用され、テストデータと本番データが混在するリスクがある
- データベースに登録されていない不要なコンテンツファイルが蓄積する可能性がある

### 目的
- コンテンツ保存先を設定で変更可能にする
- テスト環境で別フォルダを使用できるようにする
- 未登録コンテンツを検出・削除するメンテナンススクリプトを提供する

## 2. 要件

### 2.1 機能要件

#### 2.1.1 コンテンツ保存先の設定可能化
- 環境変数でコンテンツ保存先のベースパスを指定できるようにする
- 環境変数が未設定の場合は、デフォルトで `content` フォルダを使用する
- 保存先のディレクトリ構造は以下を維持する：
  ```
  {baseContentPath}/{mediaType}/{dir1}/{dir2}/{contentId}/original.{ext}
  ```
  - mediaType: `videos`, `images`, `others`
  - dir1, dir2: contentIdの先頭4文字から生成されるディレクトリ階層
  - contentId: UUID v4形式

#### 2.1.2 未登録コンテンツ削除スクリプト
- `content` フォルダ内を再帰的に走査する
- データベース（`CONTENTS` テーブル）に登録されていないコンテンツを検出する
- 検出されたコンテンツを削除する
- 実行結果をログ出力する（削除件数、削除ファイルパスなど）
- dry-runモードを提供し、削除前に確認できるようにする

## 3. 実装方針

### 3.1 環境変数

#### 3.1.1 追加する環境変数
```bash
# コンテンツ保存先のベースパス
CONTENT_BASE_PATH=content
```

#### 3.1.2 テスト環境での設定例
```bash
# .env.test
CONTENT_BASE_PATH=content_test
```

### 3.2 コード修正箇所

#### 3.2.1 ContentServiceImpl の修正
**ファイル**: `features/content/content.service.impl.ts`

**現状（39行目）**:
```typescript
this.baseContentPath = resolve("content");
```

**修正後**:
```typescript
this.baseContentPath = resolve(process.env.CONTENT_BASE_PATH || "content");
```

### 3.3 未登録コンテンツ削除スクリプト

#### 3.3.1 スクリプト仕様
**ファイル**: `scripts/cleanup-unregistered-contents.ts`

**機能**:
1. データベースから登録済みコンテンツのパス一覧を取得
2. コンテンツフォルダを再帰的に走査
3. データベースに存在しないファイル・ディレクトリを検出
4. 検出されたファイル・ディレクトリを削除（または dry-run で表示）

**コマンドライン引数**:
```bash
# dry-run モード（削除せず、対象を表示のみ）
npx tsx --env-file=.env scripts/cleanup-unregistered-contents.ts --dry-run

# 実際に削除
npx tsx --env-file=.env scripts/cleanup-unregistered-contents.ts
```

**出力例**:
```
[Dry Run] 未登録コンテンツの検出結果:
- content/videos/ab/cd/abcd1234-5678-90ef-ghij-klmnopqrstuv/original.mp4
- content/images/12/34/12345678-90ab-cdef-ghij-klmnopqrstuv/original.jpg

合計: 2件の未登録コンテンツが見つかりました

実際に削除するには、--dry-run オプションなしで実行してください。
```

#### 3.3.2 スクリプトの処理フロー

1. **環境変数の読み込み**
   - `CONTENT_BASE_PATH` からコンテンツフォルダのパスを取得
   - コマンドライン引数から `--dry-run` フラグを確認

2. **データベースからの登録済みコンテンツ取得**
   - `CONTENTS` テーブルから全レコードの `path` を取得
   - パスのSetを作成（高速検索用）

3. **コンテンツフォルダの走査**
   - `{baseContentPath}` 配下を再帰的に走査
   - `original.*` パターンのファイルを検出
   - データベースに存在しないファイルをリストアップ

4. **削除処理**
   - dry-runモード：検出結果を表示
   - 実行モード：ファイルとそれを含む空ディレクトリを削除

5. **結果の出力**
   - 削除（または検出）したファイル数とパスを表示

## 4. データベーススキーマ

### 4.1 CONTENTS テーブル
```typescript
export const CONTENTS = sqliteTable("contents", {
    id: text("id").primaryKey(),      // UUID v4
    path: text("path").notNull(),     // ファイルの完全パス
    name: text("name").notNull(),     // ファイル名（表示用）
    hash: text("hash").notNull(),     // SHA256ハッシュ値
});
```

**重要**: `path` 列には、`baseContentPath` からの相対パスではなく、完全パス（フルパス）が保存される

## 5. 影響範囲

### 5.1 既存機能への影響
- **低リスク**: 環境変数が未設定の場合は既存の動作を維持
- **互換性**: 既存のコンテンツファイルやデータベースはそのまま使用可能

### 5.2 テストへの影響
- テスト実行時に専用のフォルダを使用可能になる
- テストデータと本番データの分離が実現される

### 5.3 依存関係
- **ContentServiceImpl**: FileSystem への依存のみ（変更なし）

## 6. テスト方針

### 6.1 ユニットテスト
- [ ] ContentServiceImpl が環境変数を正しく読み取ること
- [ ] 環境変数未設定時にデフォルト値が使用されること
- [ ] カスタムパスでのファイル保存が正しく動作すること

### 6.2 統合テスト
- [ ] テスト用コンテンツフォルダが分離されること
- [ ] 既存のテストがすべてパスすること

### 6.3 スクリプトのテスト
- [ ] dry-runモードが正しく動作すること
- [ ] 未登録コンテンツが正しく検出されること
- [ ] 削除処理が正しく実行されること
- [ ] 登録済みコンテンツが誤って削除されないこと

## 7. 実装手順

1. 環境変数の追加（`.env.example` の更新）
2. `ContentServiceImpl` の修正
3. 未登録コンテンツ削除スクリプトの実装
4. テストの実装・実行
5. ドキュメント（README）の更新

## 8. 補足事項

### 8.1 セキュリティ考慮事項
- コンテンツ保存先のパスバリデーションを実施
- パストラバーサル攻撃への対策を確認

### 8.2 運用考慮事項
- コンテンツフォルダの移行手順を文書化
- バックアップ取得の推奨
- 削除スクリプト実行前の必須確認事項：
  - データベースのバックアップ取得
  - コンテンツフォルダのバックアップ取得
  - まず dry-run で実行して削除対象を確認

### 8.3 今後の拡張性
- コンテンツ保存先を複数指定可能にする（分散ストレージ対応）
- クラウドストレージ対応（S3、GCS など）
