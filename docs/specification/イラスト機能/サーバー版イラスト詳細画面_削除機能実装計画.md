# サーバー版イラスト詳細画面 削除機能実装計画

## 1. 現状分析

### 1.1 問題点
- `src/server/view/pages/illust.detail.page.tsx` にイラスト削除機能が未実装
- `IllustDetailTemplate` に `onDelete` プロパティを渡していない

### 1.2 既存実装状況

| ファイル | 削除機能 | 備考 |
|---------|---------|------|
| `src/renderer/pages/illust.detail.page.tsx` | ✅ 実装済み | Electron版（クライアント） |
| `src/server/view/pages/illust.detail.page.tsx` | ❌ 未実装 | Webサーバー版 |
| `features/illust/ui/templates/illust.detail.template.tsx` | ✅ 実装済み | UI・ダイアログ |
| `src/main/apis/illusts/illust.delete.api.ts` | ✅ 実装済み | 削除API |

### 1.3 参照コード

**Electron版（実装済み）**: `src/renderer/pages/illust.detail.page.tsx:30-47`
```tsx
const handleDelete = async () => {
  const result = await client.deleteIllust(illust.id);

  if (isFailure(result)) {
    throw new Error("削除に失敗しました");
  }

  // 検索画面へ遷移
  navigate("/illust/search");
};

return (
  <IllustDetailTemplate
    illust={illust}
    backUrl="/illust/search"
    tagUrlPrefix="/illust/search"
    onDelete={handleDelete}
  />
);
```

## 2. 実装方針

### 2.1 アーキテクチャ上の考慮点

サーバー版は以下の特性を持つ：
- サーバーコンポーネント（RSC）として動作
- クライアントからAPIを呼び出す必要がある
- `useNavigate` などのReact Routerフックは使用不可

### 2.2 実装パターン選択

**パターンA: テンプレート内で直接API呼び出し（推奨）**
- `IllustDetailTemplate` 内で削除APIを直接呼び出す
- サーバー版専用のクライアントを使用

**パターンB: ページをクライアントコンポーネント化**
- `"use client"` ディレクティブを追加
- Electron版と同様の実装パターンを適用

**選択: パターンA**
- テンプレートは既にクライアントコンポーネント（`useState` 使用）
- `onDelete` コールバック経由で柔軟に対応可能

## 3. 実装手順

### Step 1: サーバー版クライアントの確認

**確認対象**: `src/server/client.ts`

削除APIが利用可能か確認する。

### Step 2: ページコンポーネントの修正

**対象ファイル**: `src/server/view/pages/illust.detail.page.tsx`

**現在の実装**:
```tsx
import type { Illust } from "../../../../features/illust/illust.model.js";
import { IllustDetailTemplate } from "../../../../features/illust/ui/templates/illust.detail.template.js";
import { LayoutServer } from "../../../../features/shared/ui/components/layout.server.component.js";
import { ServerNavigationProvider } from "../../../../features/shared/ui/navigation.server.js";

type IllustDetailPageProps = {
  illust: Illust;
};

export default function IllustDetailPage({ illust }: IllustDetailPageProps) {
  return (
    <ServerNavigationProvider>
      <LayoutServer currentPath={`/illust/detail/${illust.id}`}>
        <IllustDetailTemplate
          illust={illust}
          backUrl="/illust/search"
          tagUrlPrefix="/illust/search"
        />
      </LayoutServer>
    </ServerNavigationProvider>
  );
}
```

**修正後の実装**:
```tsx
"use client";

import type { Illust } from "../../../../features/illust/illust.model.js";
import { IllustDetailTemplate } from "../../../../features/illust/ui/templates/illust.detail.template.js";
import { LayoutServer } from "../../../../features/shared/ui/components/layout.server.component.js";
import { ServerNavigationProvider } from "../../../../features/shared/ui/navigation.server.js";
import { client } from "../../../client.js";

type IllustDetailPageProps = {
  illust: Illust;
};

export default function IllustDetailPage({ illust }: IllustDetailPageProps) {
  const handleDelete = async () => {
    await client.illust.delete(illust.id);
    // 検索画面へ遷移
    window.location.href = "/illust/search";
  };

  return (
    <ServerNavigationProvider>
      <LayoutServer currentPath={`/illust/detail/${illust.id}`}>
        <IllustDetailTemplate
          illust={illust}
          backUrl="/illust/search"
          tagUrlPrefix="/illust/search"
          onDelete={handleDelete}
        />
      </LayoutServer>
    </ServerNavigationProvider>
  );
}
```

### Step 3: クライアントAPIの確認・追加

**確認内容**:
- `src/server/client.ts` に `illust.delete` メソッドが存在するか
- 存在しない場合は追加が必要

**想定されるクライアント実装**:
```typescript
// src/server/client.ts
export const client = {
  illust: {
    delete: async (illustId: string) => {
      const response = await fetch(`/api/illust/${illustId}`, {
        method: "DELETE",
      });
      if (!response.ok) {
        throw new Error("削除に失敗しました");
      }
      return response.json();
    },
  },
};
```

### Step 4: サーバーAPIルートの確認

**確認対象**: サーバー側の削除エンドポイント

- `/api/illust/:id` (DELETE) が存在するか確認
- 存在しない場合はルーターへの追加が必要

## 4. テスト項目

### 4.1 正常系
- [ ] 削除ボタンクリックで確認ダイアログが表示される
- [ ] 「削除」ボタンでイラストが削除される
- [ ] 削除後、検索画面 (`/illust/search`) へ遷移する
- [ ] 削除されたイラストが検索結果に表示されない

### 4.2 異常系
- [ ] 存在しないイラストIDで削除を試みた場合、エラーメッセージが表示される
- [ ] サーバーエラー時、エラーメッセージが表示される
- [ ] ネットワークエラー時、適切にハンドリングされる

### 4.3 UX確認
- [ ] 「キャンセル」ボタンでダイアログが閉じる
- [ ] 削除処理中はボタンが非活性化される（実装されている場合）

## 5. 影響範囲

- `src/server/view/pages/illust.detail.page.tsx` - 直接修正
- `src/server/client.ts` - 削除APIメソッド追加（必要な場合）
- サーバールーター - 削除エンドポイント追加（必要な場合）

## 6. 注意事項

- サーバー版とElectron版で削除処理のパターンが異なる
  - Electron版: `ApiService.deleteIllust()` + `useNavigate()`
  - サーバー版: `client.illust.delete()` + `window.location.href`
- テンプレート (`IllustDetailTemplate`) は共通で使用するため変更不要
- `onDelete` コールバックのインターフェースは既に定義済み

## 7. 作業見積もり

| 作業項目 | 内容 |
|---------|------|
| クライアントAPI確認・追加 | `src/server/client.ts` の確認と修正 |
| ページコンポーネント修正 | `illust.detail.page.tsx` への `onDelete` 追加 |
| サーバールート確認 | 削除エンドポイントの確認 |
| テスト | 正常系・異常系の動作確認 |
