# イラスト登録画面 仕様書

## 1. 概要

新規イラストを登録するための画面。タグ（複数）、作者（複数）、コンテンツファイル（複数）を入力・選択して登録する。

## 2. URL

- **パス**: `/illust/register`

## 3. 画面遷移

### 遷移元
- イラスト検索画面の「新規作成」ボタン

### 遷移先
- **イラスト登録画面（リロード）**: 登録成功後 → `/illust/register`（ページをリロードして初期状態に戻す）
- **イラスト検索画面**: 「キャンセル」ボタンをクリック → `/illust/search`

## 4. 機能要件

### 4.1 入力項目

#### タグ（オプション、複数選択可能）
- **タイプ**: タグ入力コンポーネント（既存タグから選択 + 新規タグ作成）
- **既存実装**: `features/tag/ui/tag.input.component.tsx`
- **動作**:
  - タグ検索による既存タグの絞り込み
  - 既存タグがない場合は新規タグとして登録
  - 選択したタグはチップとして表示
  - 「×」ボタンでタグを削除
- **バリデーション**:
  - タグ名: 1文字以上、100文字以下

#### 作者（オプション、複数選択可能）
- **タイプ**: 作者選択モーダル
- **既存実装**: `features/author/ui/components/author.select.modal.component.tsx`
- **動作**:
  - 「作者を追加」ボタンをクリックしてモーダルを開く
  - モーダル内で既存作者を検索・選択、または新規作者を登録
  - 選択した作者はカードとして表示
  - 「削除」ボタンで作者を削除
- **バリデーション**: なし（オプション）

#### コンテンツファイル（必須、複数選択可能）
- **タイプ**: ファイル選択 + ドラッグ&ドロップ
- **対応形式**: 画像ファイル（.jpg, .jpeg, .png, .gif, .webp, .bmp）
- **動作**:
  - 「ファイルを選択」ボタンまたはドラッグ&ドロップでファイルを追加
  - 選択したファイルはプレビュー付きサムネイルとして表示
  - 各ファイルには「上へ」「下へ」ボタンで並び順を変更可能
  - 「削除」ボタンでファイルを削除
  - 最初のファイルがデフォルトのサムネイルとなる
- **バリデーション**:
  - 最低1枚以上のファイルが必須
  - ファイルサイズ: 1ファイルあたり最大50MB
  - ファイル形式チェック
- **エラーメッセージ**:
  - ファイル未選択: 「コンテンツファイルを1枚以上選択してください」
  - 非対応形式: 「対応していないファイル形式です」
  - サイズ超過: 「ファイルサイズは50MB以下にしてください」

### 4.2 操作

- **「登録」ボタン**:
  - バリデーションを実行
  - 成功したらイラスト登録APIを呼び出し
  - 成功したら同じページ（`/illust/register`）をリロード
  - 「イラストを登録しました」とトーストメッセージを表示

- **「キャンセル」ボタン**:
  - 入力内容を破棄
  - イラスト検索画面へ戻る

- **コンテンツファイルの並び替え**:
  - 各ファイルの「上へ」「下へ」ボタンで並び順を変更
  - 並び順は表示順序として保存される

## 5. 画面レイアウト

```
+------------------------------------------+
| ナビゲーション                              |
+------------------------------------------+
| イラスト登録                                |
+------------------------------------------+
| タグ (オプション)                           |
| [タグを入力...] 🔍                         |
| [タグ1 ×] [タグ2 ×] [タグ3 ×]             |
|                                          |
| 作者 (オプション)                           |
| [作者を追加] ➕                             |
| +----------------------------------+     |
| | [作者1]          [削除]          |     |
| +----------------------------------+     |
| | [作者2]          [削除]          |     |
| +----------------------------------+     |
|                                          |
| コンテンツファイル (必須)                    |
| [ファイルを選択] または ドラッグ&ドロップ      |
| +----------------------------------+     |
| | [プレビュー画像1]  [↑] [↓] [削除] |     |
| | ファイル名1.jpg                   |     |
| +----------------------------------+     |
| | [プレビュー画像2]  [↑] [↓] [削除] |     |
| | ファイル名2.jpg                   |     |
| +----------------------------------+     |
| | [プレビュー画像3]  [↑] [↓] [削除] |     |
| | ファイル名3.jpg                   |     |
| +----------------------------------+     |
|                                          |
| [登録] [キャンセル]                        |
+------------------------------------------+
```

## 6. 技術仕様

### 6.1 ルーティング

- **URL**: `/illust/register`

### 6.2 データモデル

#### Illust型
```typescript
export type Illust = {
  id: string;
  createdAt: string;
  updatedAt: string;
};
```

#### IllustContent型
```typescript
export type IllustContent = {
  id: string;
  illustId: string;
  filePath: string;
  order: number; // 並び順（0から開始）
};
```

#### Illusts_Tags中間テーブル
```typescript
export type IllustsToTags = {
  illustId: string;
  tagId: string;
};
```

#### Illusts_Authors中間テーブル
```typescript
export type IllustsToAuthors = {
  illustId: string;
  authorId: string;
};
```

### 6.3 API

#### イラスト登録API

**エンドポイント**: `src/main/apis/illusts/illust.register.api.ts`

**参考実装**: `src/main/apis/videos/video.register.api.ts`

**リクエスト**:
```typescript
import { z } from "zod";

export const registerIllustSchema = z.object({
  resourceIds: z.array(z.string()), // 未管理コンテンツのIDの配列
  rawTags: z.string(), // タグ名（スペース区切り）
  authorIds: z.array(z.string()).optional(), // 作者IDの配列（オプション）
});

export type RegisterIllustRequest = z.infer<typeof registerIllustSchema>;
```

**処理フロー**:
```typescript
export async function registerIllust(
  ctx: Context,
  request: RegisterIllustRequest,
) {
  // 1. zodスキーマでバリデーション
  const valid = registerIllustSchema.safeParse(request);
  if (!valid.success) {
    throw new Error("Invalid request");
  }

  // 2. jobQueueにenqueueして非同期処理
  jobQueue.enqueue({
    name: "register-illust",
    input: valid.data,
    handle: async () => {
      return database.transaction(async (tx) => {
        return fileSystem.transaction(async (fs) => {
          // 3. トランザクション内で処理:
          // - 各resourceIdから未管理コンテンツを取得
          // - 各コンテンツをcontentとして登録
          // - タグをgetOrCreate
          // - 作者をauthorRepositoryから取得
          // - イラストを登録
          // - 中間テーブル（Illusts_Tags, Illusts_Authors, Illusts_Contents）に登録
          // - タグ共起行列を更新
        });
      });
    },
    onSuccess: (illust) => {
      logger.info("Illust registered successfully", { illust });
    },
    onError: (error) => {
      logger.error("Failed to register illust", { error });
    },
  });
}
```

**レスポンス**:
```typescript
// jobQueueに登録されるため即座にレスポンスは返らない
// 登録成功時はページリロードで処理
```

### 6.4 UIコンポーネント

- **ページコンポーネント**: `src/renderer/pages/illust.register.page.tsx`
- **テンプレートコンポーネント**: `features/illust/ui/templates/illust.register.template.tsx`
- **サーバールート**: `src/server/router/illust/register.tsx`
- **コンテンツファイル入力コンポーネント**: `features/illust/ui/components/illust.content.input.component.tsx`

### 6.5 状態管理

```typescript
const [selectedTags, setSelectedTags] = useState<Tag[]>([]);
const [selectedAuthors, setSelectedAuthors] = useState<Author[]>([]);
const [contentFiles, setContentFiles] = useState<{
  id: string; // 一時ID
  file: File;
  preview: string; // プレビュー用URL
  order: number;
}[]>([]);
const [errors, setErrors] = useState<{
  contentFiles?: string;
}>({});
```

### 6.6 ファイル処理

#### ファイル選択・追加
```typescript
const handleFileSelect = (files: FileList) => {
  const validFiles: File[] = [];

  for (const file of Array.from(files)) {
    // ファイル形式チェック
    if (!file.type.startsWith('image/')) {
      // エラー処理
      continue;
    }

    // サイズチェック
    if (file.size > 50 * 1024 * 1024) { // 50MB
      // エラー処理
      continue;
    }

    validFiles.push(file);
  }

  // プレビューURLを生成して追加
  const newContentFiles = validFiles.map((file, index) => ({
    id: crypto.randomUUID(),
    file,
    preview: URL.createObjectURL(file),
    order: contentFiles.length + index,
  }));

  setContentFiles([...contentFiles, ...newContentFiles]);
};
```

#### 並び順変更（上へ・下へボタン）
```typescript
const moveUp = (index: number) => {
  if (index === 0) return; // 最初の要素は上に移動できない

  const items = [...contentFiles];
  [items[index - 1], items[index]] = [items[index], items[index - 1]];

  // orderを再設定
  const reorderedItems = items.map((item, i) => ({
    ...item,
    order: i,
  }));

  setContentFiles(reorderedItems);
};

const moveDown = (index: number) => {
  if (index === contentFiles.length - 1) return; // 最後の要素は下に移動できない

  const items = [...contentFiles];
  [items[index], items[index + 1]] = [items[index + 1], items[index]];

  // orderを再設定
  const reorderedItems = items.map((item, i) => ({
    ...item,
    order: i,
  }));

  setContentFiles(reorderedItems);
};
```

#### ファイル削除
```typescript
const handleRemoveFile = (id: string) => {
  const fileToRemove = contentFiles.find(f => f.id === id);
  if (fileToRemove) {
    // プレビューURLを解放
    URL.revokeObjectURL(fileToRemove.preview);
  }

  const newFiles = contentFiles.filter(f => f.id !== id);
  // orderを再設定
  const reorderedFiles = newFiles.map((file, index) => ({
    ...file,
    order: index,
  }));

  setContentFiles(reorderedFiles);
};
```

#### コンポーネントのクリーンアップ
```typescript
useEffect(() => {
  // コンポーネントのアンマウント時にプレビューURLを解放
  return () => {
    for (const file of contentFiles) {
      URL.revokeObjectURL(file.preview);
    }
  };
}, [contentFiles]);
```

## 7. バリデーション

### クライアント側バリデーション

```typescript
const validate = () => {
  const newErrors: {contentFiles?: string} = {};

  // コンテンツファイル
  if (contentFiles.length === 0) {
    newErrors.contentFiles = "コンテンツファイルを1枚以上選択してください";
  }

  setErrors(newErrors);
  return Object.keys(newErrors).length === 0;
};
```

### サーバー側バリデーション

- コンテンツファイルの存在チェック（最低1枚）
- ファイル形式チェック
- ファイルサイズチェック
- 未管理コンテンツの存在チェック

## 8. エラーハンドリング

- **バリデーションエラー**: フォーム内に赤文字でエラーメッセージを表示
- **ファイル形式エラー**: 該当ファイルの下にエラーメッセージを表示
- **ファイルサイズエラー**: 該当ファイルの下にエラーメッセージを表示
- **API失敗**: 「登録に失敗しました」とトーストメッセージを表示
- **ネットワークエラー**: リトライボタンを表示

## 9. 成功時の動作

1. イラスト登録APIを呼び出し（jobQueueにenqueue）
2. `/illust/register`をリロード（入力フォームがリセットされる）
3. 「イラストを登録しました」とトーストメッセージを表示

## 10. パフォーマンス要件

- **フォーム表示**: 即座に表示
- **ファイルプレビュー生成**: 1ファイルあたり500ms以内
- **登録処理**: 非同期処理（jobQueue）のためユーザーは待たない
- **大量ファイル対応**: 最大100枚まで対応

## 11. アクセシビリティ

- 必須フィールドに`required`属性
- エラーメッセージとフィールドを関連付け（`aria-describedby`）
- キーボードナビゲーション対応
- フォーカス管理（エラー時は最初のエラーフィールドにフォーカス）
- スクリーンリーダー対応（画像プレビューにalt属性）

## 12. セキュリティ考慮事項

- **ファイルアップロード**:
  - ファイル形式の厳密なチェック（MIMEタイプとファイル拡張子の両方）
  - ファイルサイズ制限の厳密な適用
  - ファイル名のサニタイズ（パストラバーサル対策）
  - アップロード先ディレクトリのアクセス制御

- **入力値のサニタイズ**:
  - SQLインジェクション対策（プリペアドステートメント使用）

## 13. 実装時の注意点

- **ファイル保存先**: `content/illusts/` ディレクトリ
- **ファイル命名規則**: `{illustId}_{order}.{拡張子}`
- **プレビューURL管理**: コンポーネントのアンマウント時に必ず`URL.revokeObjectURL()`を呼び出してメモリリークを防ぐ
- **並び順の管理**: orderは0から開始し、連番で管理
- **トランザクション**: イラスト、コンテンツ、中間テーブルの登録は一つのトランザクションで処理
- **動画登録との類似性**: 動画登録機能（`video.register.api.ts`）と同様のパターンで実装
