# イラスト削除機能 仕様書

## 1. 概要
イラスト詳細画面から既存イラストを削除する機能。イラストと関連データ（コンテンツファイル、タグ・作者との紐付け）をすべて削除し、削除後は検索画面へ遷移する。

## 2. UI配置
- **配置場所**: イラスト詳細画面の画像情報セクション下部
- **既存実装**: `features/illust/ui/templates/illust.detail.template.tsx:115-120`
- **ボタンデザイン**: `NegativeButton`（赤系の警告色）

```tsx
<NegativeButton
  onClick={handleDelete}
  className="flex-1"
>
  削除
</NegativeButton>
```

## 3. 画面遷移

### 3.1 削除実行前
- **現在地**: イラスト詳細画面 (`/illust/:id`)
- **確認ダイアログ**: 削除ボタンクリック時に表示

### 3.2 削除実行後
- **遷移先**: イラスト検索画面 (`/illust/search`)
- **通知**: 「イラストを削除しました」とトーストメッセージを表示

## 4. 機能要件

### 4.1 削除確認ダイアログ
- **表示タイミング**: 削除ボタンクリック時
- **メッセージ**: 「このイラストを削除しますか? この操作は取り消せません。」
- **ボタン構成**:
  - 「削除」ボタン（赤系の警告色）: 削除を実行
  - 「キャンセル」ボタン（グレー系）: ダイアログを閉じる

### 4.2 削除処理
以下のデータをすべて削除する：
1. **イラストレコード**: `illusts` テーブルのレコード
2. **コンテンツレコード**: `illust_contents` テーブルのレコード
3. **物理ファイル**: イラストの画像ファイル（`content/` ディレクトリ配下）
4. **中間テーブル**:
   - `illusts_tags` テーブル（イラストとタグの紐付け）
   - `illusts_authors` テーブル（イラストと作者の紐付け）

### 4.3 トランザクション管理
- データベース操作とファイルシステム操作を1つのトランザクションで処理
- 処理途中でエラーが発生した場合はロールバック

## 5. 技術仕様

### 5.1 API実装

**参考実装**: 作者削除API (`src/main/apis/authors/author.delete.api.ts`)

**エンドポイント**: `src/main/apis/illusts/illust.delete.api.ts`

**リクエスト**:
```typescript
import { z } from "zod";

export const deleteIllustSchema = z.object({
  illustId: z.string(),
});

export type DeleteIllustRequest = z.infer<typeof deleteIllustSchema>;
```

**処理フロー**:
```typescript
export async function deleteIllust(
  ctx: Context,
  request: DeleteIllustRequest,
) {
  const valid = deleteIllustSchema.safeParse(request);
  if (!valid.success) {
    throw new Error("Invalid request");
  }

  return database.transaction(async (tx) => {
    return fileSystem.transaction(async (fs) => {
      // 1. イラストデータを取得
      const illust = await illustRepository.findById(valid.data.illustId);
      if (!illust) {
        throw new Error("Illust not found");
      }

      // 2. 関連する物理ファイルを削除
      for (const content of illust.contents) {
        await fs.deleteFile(content.content.path);
      }

      // 3. データベースから削除（CASCADE設定により関連データも削除）
      await illustRepository.delete(valid.data.illustId);

      return { success: true };
    });
  });
}
```

### 5.2 electron-flow自動生成
APIを作成すると、electron-flowが以下を自動生成：

**`src/renderer/autogenerate/register.tsx` に追加される内容**:
```typescript
// window.api の型定義に追加
declare global {
  interface Window {
    api: {
      // ...existing methods
      deleteIllust: (illustId: string) => Promise<Result<ReturnTypeUnwrapped<typeof deleteIllust>, Error>>;
    };
  }
}

// ServiceIF インターフェースに追加
export interface ServiceIF {
  // ...existing methods
  deleteIllust: (illustId: string) => Promise<Result<ReturnTypeUnwrapped<typeof deleteIllust>, Error>>;
}

// ApiService クラスに追加
export class ApiService implements ServiceIF {
  // ...existing methods

  async deleteIllust(illustId: string) {
    return window.api.deleteIllust(illustId);
  }
}
```

### 5.3 UIコンポーネント実装

**ファイル**: `features/illust/ui/templates/illust.detail.template.tsx`

**実装内容**:
```tsx
import { useState } from "react";
import { isFailure } from "electron-flow/result";
import { ApiService } from "../../../../src/renderer/autogenerate/register.js";

const client = new ApiService();

export function IllustDetailTemplate({ illust, backUrl, tagUrlPrefix = "/" }) {
  const { navigate } = useNavigation();
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);

  const handleDelete = () => {
    setShowDeleteDialog(true);
  };

  const confirmDelete = async () => {
    try {
      // electron-flowが生成したApiServiceを使用
      const result = await client.deleteIllust(illust.id);

      if (isFailure(result)) {
        throw new Error("削除に失敗しました");
      }

      // 成功通知（トースト実装は既存のパターンに従う）
      // alert("イラストを削除しました");

      // 検索画面へ遷移
      navigate("/illust/search");
    } catch (error) {
      alert("削除に失敗しました");
    } finally {
      setShowDeleteDialog(false);
    }
  };

  const cancelDelete = () => {
    setShowDeleteDialog(false);
  };

  return (
    <main className="container mx-auto px-2 pt-10">
      {/* 削除確認ダイアログ */}
      {showDeleteDialog && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
          <div className="rounded-lg bg-white p-6 shadow-xl">
            <h3 className="mb-4 font-bold text-lg">イラストの削除</h3>
            <p className="mb-6 text-gray-700">
              このイラストを削除しますか？<br />
              この操作は取り消せません。
            </p>
            <div className="flex justify-end gap-4">
              <NeutralButton onClick={cancelDelete}>
                キャンセル
              </NeutralButton>
              <NegativeButton onClick={confirmDelete}>
                削除
              </NegativeButton>
            </div>
          </div>
        </div>
      )}

      {/* 既存のUI */}
      {/* ... */}

      <NegativeButton
        onClick={handleDelete}
        className="flex-1"
      >
        削除
      </NegativeButton>
    </main>
  );
}
```

### 5.4 データベーススキーマ設定
- 中間テーブル（`illusts_tags`, `illusts_authors`, `illust_contents`）の外部キー制約に `ON DELETE CASCADE` を設定
- イラストレコード削除時に自動的に関連レコードも削除される

## 6. バリデーション

### 6.1 削除前チェック
- イラストIDが存在するか確認
- イラストが既に削除されていないか確認

### 6.2 エラーケース
- **イラストが見つからない**: 「削除対象のイラストが見つかりませんでした」
- **ファイル削除失敗**: 「ファイルの削除に失敗しました」
- **データベースエラー**: 「削除処理中にエラーが発生しました」

## 7. エラーハンドリング
- トランザクションによる自動ロールバック
- ユーザーへのエラーメッセージ表示（ダイアログまたはトースト）
- エラーログの記録（`logger.error()`）
- electron-flowの`Result`型を使った安全なエラー処理

```typescript
const result = await client.deleteIllust(illustId);

if (isFailure(result)) {
  // エラー処理
  console.error(result.error);
  alert("削除に失敗しました");
  return;
}

// 成功時の処理
const data = result.value;
```

## 8. セキュリティ考慮事項
- **削除確認**: 誤操作防止のため必ず確認ダイアログを表示
- **権限チェック**: 将来的にユーザー管理機能が追加された場合、削除権限の確認を追加
- **パストラバーサル対策**: ファイルパスのサニタイズを実施

## 9. UX考慮事項
- **確認ダイアログ**: 削除の重大性を明確に伝える
- **処理中の表示**: 削除処理中はボタンを非活性化し、ローディング表示
- **即座のフィードバック**: 削除成功時は即座にトースト通知と画面遷移

## 10. 実装時の注意点
- 削除処理は非可逆的なため、確認ダイアログは必須
- トランザクション内でデータベースとファイルシステムの両方を処理
- 作者削除機能（`author.delete.api.ts`）と同様のパターンで実装
- electron-flowの自動生成を活用するため、APIファイルを作成後、ビルドを実行して`register.tsx`を更新
- テスト環境での動作確認を十分に実施

## 11. 実装手順

1. **API作成**: `src/main/apis/illusts/illust.delete.api.ts` を作成
2. **ビルド実行**: electron-flowが `register.tsx` を自動更新
3. **UI実装**: `illust.detail.template.tsx` に削除ダイアログと処理を追加
4. **動作確認**: テスト環境で削除機能を検証
5. **エラーケース確認**: 各種エラーケースの動作を検証
