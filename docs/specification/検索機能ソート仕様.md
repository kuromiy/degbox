# 検索機能ソート仕様書

## 1. 概要

### 1.1 背景
- 動画（`videos`）、作者（`authors`）、イラスト（`illusts`）テーブルに作成日・更新日カラムを追加済み
- ユーザーが検索結果を任意の順序で並び替えられる機能が必要

### 1.2 目的
各検索機能にソート機能を追加し、ユーザビリティを向上させる

### 1.3 対象機能
- 動画検索（`/api/videos/search`）
- イラスト検索（`/api/illusts/search`）

## 2. データベーススキーマ

### 2.1 既存カラム
以下のテーブルに `created_at`, `updated_at` が追加済み：

```typescript
// 動画テーブル
VIDEOS = {
  id: text("id").primaryKey(),
  createdAt: text("created_at").notNull().default(sql`CURRENT_TIMESTAMP`),
  updatedAt: text("updated_at").notNull().default(sql`CURRENT_TIMESTAMP`),
}

// イラストテーブル
ILLUSTS = {
  id: text("id").primaryKey(),
  createdAt: text("created_at").notNull().default(sql`CURRENT_TIMESTAMP`),
  updatedAt: text("updated_at").notNull().default(sql`CURRENT_TIMESTAMP`),
}

// 作者テーブル
AUTHORS = {
  id: text("id").primaryKey(),
  name: text("name").notNull(),
  urls: text("urls", { mode: "json" }).$type<Record<string, string>>().notNull(),
  createdAt: text("created_at").notNull().default(sql`CURRENT_TIMESTAMP`),
  updatedAt: text("updated_at").notNull().default(sql`CURRENT_TIMESTAMP`),
}
```

## 3. ソート機能仕様

### 3.1 ソート項目

| 項目 | パラメータ値 | 説明 | デフォルト |
|------|-------------|------|-----------|
| 作成日時 | `createdAt` | 作成日時 | ✓ |
| 更新日時 | `updatedAt` | 更新日時 | |
| ID | `id` | コンテンツID（UUID） | |

### 3.2 ソート順

| 順序 | パラメータ値 | 説明 | デフォルト |
|------|-------------|------|-----------|
| 昇順 | `asc` | 古い順 → 新しい順 | |
| 降順 | `desc` | 新しい順 → 古い順 | ✓ |

### 3.3 APIパラメータ

#### 動画検索 API
```
GET /api/videos/search
```

**クエリパラメータ**：
- `keyword` (string, optional): 検索キーワード（タグ名での部分一致）
- `page` (number, required): ページ番号（0始まり）
- `size` (number, required): 1ページあたりの件数（1-100）
- `sortBy` (string, optional): ソート項目（`createdAt` | `updatedAt` | `id`）デフォルト: `createdAt`
- `order` (string, optional): ソート順（`asc` | `desc`）デフォルト: `desc`

#### イラスト検索 API
```
GET /api/illusts/search
```

**クエリパラメータ**：
- `tag` (string, optional): タグ名（前方一致）
- `page` (number, required): ページ番号（0始まり）
- `limit` (number, required): 1ページあたりの件数（1-100）
- `sortBy` (string, optional): ソート項目（`createdAt` | `updatedAt` | `id`）デフォルト: `createdAt`
- `order` (string, optional): ソート順（`asc` | `desc`）デフォルト: `desc`

### 3.4 バリデーション

#### sortBy
- 許可値: `createdAt`, `updatedAt`, `id`
- 不正な値の場合: デフォルト値 `createdAt` を使用

#### order
- 許可値: `asc`, `desc`
- 不正な値の場合: デフォルト値 `desc` を使用

## 4. 実装状況

### 4.1 イラスト検索（`IllustDataSource`）
**状態**: 部分実装

**現状**:
- `sortBy`, `order` パラメータは既に受け付けている
- しかし、`sortBy` が実際には使用されておらず、常に `ILLUSTS.id` でソート
- `order` パラメータのみ機能している

**必要な作業**:
- `sortBy` パラメータに応じて、`ILLUSTS.createdAt` または `ILLUSTS.updatedAt` でソートする処理を追加
- デフォルト値を `createdAt` に変更
- バリデーション処理の追加

### 4.2 動画検索（`VideoDataSource`）
**状態**: 未実装

**現状**:
- `sortBy`, `order` パラメータを受け付けていない
- 固定で `desc(VIDEOS.id)` によるソート

**必要な作業**:
- `search` メソッドに `sortBy`, `order` パラメータを追加
- ソートロジックの実装（デフォルト: `createdAt`, `desc`）
- バリデーション処理の追加

## 5. 実装方針

### 5.1 共通処理
ソート項目とソート順の組み合わせに応じて、適切な `orderBy` 句を生成する。

```typescript
// 疑似コード
function getOrderBy(sortBy: string, order: string) {
  const column =
    sortBy === 'updatedAt' ? TABLE.updatedAt :
    sortBy === 'id' ? TABLE.id :
    TABLE.createdAt; // デフォルト

  return order === 'asc' ? asc(column) : desc(column);
}
```

### 5.2 段階的な実装

1. **Phase 1**: 動画検索にソートパラメータを追加（デフォルト: `createdAt`, `desc`）
2. **Phase 2**: イラスト検索の`sortBy`機能を修正（デフォルトを`createdAt`に変更）
3. **Phase 3**: バリデーションとエラーハンドリングの追加

### 5.3 テスト項目
- [ ] デフォルト値でのソート（`createdAt`, `desc`）
- [ ] `createdAt` での昇順・降順ソート
- [ ] `updatedAt` での昇順・降順ソート
- [ ] `id` での昇順・降順ソート
- [ ] 不正な `sortBy` 値でのフォールバック
- [ ] 不正な `order` 値でのフォールバック
- [ ] ページネーションとソートの組み合わせ

## 6. UI要件（参考）

### 6.1 ソート選択UI
検索結果画面にソート選択のドロップダウンまたはボタンを配置：
- 「新しい順（作成日）」（デフォルト選択）
- 「古い順（作成日）」
- 「更新日時（新しい順）」
- 「更新日時（古い順）」

### 6.2 表示
- 現在のソート条件を視覚的に表示
- ソート変更時は1ページ目にリセット

## 7. 備考
- `AUTHORS` テーブルにも `createdAt`, `updatedAt` が追加されているが、作者検索のソート機能は今回の対象外
- 将来的に作者検索にもソート機能を追加する可能性あり
- デフォルトのソート項目を作成日（`createdAt`）とすることで、新しく追加されたコンテンツが優先的に表示される
