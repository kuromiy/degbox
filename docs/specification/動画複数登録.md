# 動画複数登録機能 - 仕様書

## 1. 概要
動画登録機能を現在の単一動画登録から、イラスト登録と同様に複数動画を登録できるように拡張する。

## 2. 現状の課題
- 動画登録は現在1動画のみ対応
- イラスト登録は既に複数登録に対応しており、並び順を保持
- 動画でも複数のコンテンツを管理したいニーズがある

## 3. 要件
1. **複数動画登録**: 1つの動画エントリに複数の動画ファイルを登録可能
2. **並び順保持**: イラスト登録と同様に各動画の順序（order）を保持
3. **サムネイル生成**: 最初の動画（order: 0）からサムネイルとプレビューGIFを生成
4. **UI操作**: 動画の順序変更（上下移動）、削除、追加が可能

## 4. データモデルの変更

### 4.1 現在のVideoモデル
```typescript
export type Video = {
	id: string;
	previewGifPath: string;
	thumbnailPath: string;
	contents: Content[];        // 配列だが単一のみ使用
	tags: Tag[];
	authors: Author[];
};
```

### 4.2 変更後のVideoモデル
```typescript
export type VideoContent = {
	content: Content;
	order: number;              // 並び順を追加
};

export type Video = {
	id: string;
	previewGifPath: string;
	thumbnailPath: string;
	contents: VideoContent[];   // OrderとContentのペア
	tags: Tag[];
	authors: Author[];
};
```

**変更点**:
- `Content[]` → `VideoContent[]` に変更
- 各コンテンツに `order` プロパティを追加（イラストと同様）

## 5. API変更

### 5.1 現在のAPI（video.register.api.ts）
```typescript
export const registerVideoSchema = z.object({
	resourceId: z.string(),              // 単数
	rawTags: z.string(),
	authorId: z.string().optional(),
});
```

### 5.2 変更後のAPI
```typescript
export const registerVideoSchema = z.object({
	resourceIds: z.array(z.string()).min(1), // 複数に対応
	rawTags: z.string(),
	authorIds: z.array(z.string()).optional(), // 複数作者対応（イラストと統一）
};
```

**変更点**:
- `resourceId` → `resourceIds` (配列)
- `authorId` → `authorIds` (配列、イラストと統一)

## 6. Video Action変更

### 6.1 現在のVideoAction
```typescript
async register(tags: Tag[], content: Content, author?: Author)
```

### 6.2 変更後のVideoAction
```typescript
async register(tags: Tag[], contents: Content[], authors?: Author[])
```

**処理フロー**:
1. 複数のコンテンツ配列を受け取る
2. 各コンテンツに順序（order）を付与
3. **最初のコンテンツ（order: 0）** からサムネイルとGIFを生成
4. VideoContentとして保存

### 6.3 実装例
```typescript
async register(tags: Tag[], contents: Content[], authors?: Author[]) {
	const id = await this.repository.generateId();

	// 最初のコンテンツからメディアファイル生成
	const firstContent = contents[0];
	if (!firstContent) {
		throw new Error("At least one content is required");
	}

	const fullPath = join(firstContent.path, firstContent.name);
	const outputDir = firstContent.path;

	// HLS、サムネイル、GIF生成（最初の動画のみ）
	await this.service.generateHls(
		fullPath,
		join(outputDir, "hls", "segment_%03d.ts"),
		join(outputDir, "index.m3u8"),
	);
	await this.service.generateThumbnail(
		fullPath,
		join(outputDir, "thumbnail.jpg"),
	);
	await this.service.generateThumbnailGif(
		fullPath,
		join(outputDir, "preview.gif"),
	);

	// コンテンツに並び順を付与
	const videoContents = contents.map((content, index) => ({
		content,
		order: index,
	}));

	const video = {
		id,
		tags,
		previewGifPath: join(outputDir, "preview.gif"),
		thumbnailPath: join(outputDir, "thumbnail.jpg"),
		contents: videoContents,
		authors: authors || [],
	};

	return await this.repository.save(video);
}
```

## 7. UI変更

### 7.1 新規コンポーネント作成
イラスト登録の `illust.content.input.component.tsx` を参考に、動画版を作成。

**ファイル**: `features/video/ui/components/video.content.input.component.tsx`

**主な機能**:
1. **動画選択**: `pickupVideo()` で複数動画を選択
2. **順序管理**: ↑↓ボタンで順序変更
3. **削除**: 各動画を削除可能
4. **プレビュー**: 各動画のプレビュー表示
5. **サムネイル表示**: 最初の動画（order: 0）に「サムネイル」ラベル表示

### 7.2 UI要素
```typescript
type ContentFile = {
	id: string;
	resourceId: string;
	name: string;
	order: number;
};
```

**表示内容**:
- 動画プレビュー（video要素）
- ファイル名
- 順序番号（index + 1）
- 最初の動画に「(サムネイル)」表示
- ↑↓ボタンで順序変更
- 削除ボタン

## 8. データベース変更

### 8.1 マイグレーション
既存の `video_contents` テーブルに `order` カラムを追加。

```sql
ALTER TABLE video_contents ADD COLUMN "order" INTEGER NOT NULL DEFAULT 0;
```

### 8.2 インデックス
```sql
CREATE INDEX idx_video_contents_video_id_order ON video_contents(video_id, "order");
```

## 9. サムネイル生成ロジック

**重要**: サムネイルとプレビューGIFは **最初の動画（order: 0）のみ** から生成する。

**理由**:
1. パフォーマンス: 複数動画全てから生成すると時間がかかる
2. 代表性: 最初の動画がエントリ全体を代表
3. イラストとの統一性: イラストも最初の画像がサムネイル

## 10. テストケース

### 10.1 正常系
- [ ] 複数動画（2つ以上）を登録できる
- [ ] 1つの動画のみでも登録できる
- [ ] 順序が正しく保持される
- [ ] 最初の動画からサムネイルとGIFが生成される
- [ ] タグと作者が正しく関連付けられる

### 10.2 UI操作
- [ ] 動画を追加できる
- [ ] 動画の順序を変更できる（↑↓ボタン）
- [ ] 動画を削除できる
- [ ] 削除後に順序が再計算される
- [ ] 最初の動画に「(サムネイル)」表示がある

### 10.3 異常系
- [ ] 動画が1つも選択されていない場合にエラー
- [ ] 存在しないresourceIdの場合にエラー
- [ ] サムネイル生成失敗時のエラーハンドリング

### 10.4 既存データ
- [ ] 既存の単一動画データが正しく表示される
- [ ] マイグレーション後も既存データが壊れない

## 11. 実装の優先順位

### Phase 1: バックエンド
1. データモデル変更（video.model.ts）
2. データベースマイグレーション
3. Video Action変更（video.action.ts）
4. API変更（video.register.api.ts）
5. Repository変更（video.repository.ts）

### Phase 2: フロントエンド
1. VideoContentInputコンポーネント作成
2. 動画登録ページ更新
3. 動画詳細ページ更新（複数動画表示）

### Phase 3: テスト
1. ユニットテスト
2. E2Eテスト
3. マイグレーションテスト

## 12. 参考実装

### イラスト登録
- `features/illust/illust.model.ts`
- `features/illust/illust.action.ts`
- `features/illust/ui/components/illust.content.input.component.tsx`
- `src/main/apis/illusts/illust.register.api.ts`

### 現在の動画登録
- `features/video/video.model.ts`
- `features/video/video.action.ts`
- `src/main/apis/videos/video.register.api.ts`

## 13. 注意事項

1. **互換性**: 既存の単一動画データとの互換性を保つ
2. **パフォーマンス**: 複数動画のサムネイル生成は最初の動画のみ
3. **エラーハンドリング**: 一部の動画処理が失敗した場合のロールバック
4. **UI/UX**: イラスト登録と操作感を統一
5. **テスト**: 既存の動画機能が壊れていないか確認
